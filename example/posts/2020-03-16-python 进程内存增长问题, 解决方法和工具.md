---
title: python è¿›ç¨‹å†…å­˜å¢é•¿é—®é¢˜, è§£å†³æ–¹æ³•å’Œå·¥å…·
subtitle: æ–‡ç« æš‚å­˜
author: systemime
date: 2020-03-16
header_img: /img/in-post/2020-10-29/header.jpg
catalog: true
tags:
  - python
---

æ¬¢è¿æ¥åˆ°æˆ‘çš„ä¸–ç•Œ.

<!-- more -->

06 May 2017 on tech programming

-   [è¡¨ç°](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#%E8%A1%A8%E7%8E%B0)
-   [è§£å†³æ–¹æ³•](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95)
-   [å®šä½é—®é¢˜è¿‡ç¨‹](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#%E5%AE%9A%E4%BD%8D%E9%97%AE%E9%A2%98%E8%BF%87%E7%A8%8B)
    -   [gdb-python: ææ¸…æ¥š python ç¨‹åºåœ¨åšä»€ä¹ˆ](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#gdb-python-%E6%90%9E%E6%B8%85%E6%A5%9Apython%E7%A8%8B%E5%BA%8F%E5%9C%A8%E5%81%9A%E4%BB%80%E4%B9%88)
        -   [å‡†å¤‡ gdb](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#%E5%87%86%E5%A4%87gdb)
        -   [æ¥å…¥ gdb](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#%E6%8E%A5%E5%85%A5gdb)
        -   [æŸ¥çœ‹çº¿ç¨‹](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#%E6%9F%A5%E7%9C%8B%E7%BA%BF%E7%A8%8B)
        -   [æŸ¥çœ‹è°ƒç”¨æ ˆ](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#%E6%9F%A5%E7%9C%8B%E8%B0%83%E7%94%A8%E6%A0%88)
        -   [coredump](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#coredump)
        -   [å…¶ä»–å‘½ä»¤](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#%E5%85%B6%E4%BB%96%E5%91%BD%E4%BB%A4)
    -   [pyrasite: è¿æ¥è¿›å…¥ python ç¨‹åº](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#pyrasite-%E8%BF%9E%E6%8E%A5%E8%BF%9B%E5%85%A5python%E7%A8%8B%E5%BA%8F)
    -   [psutil æŸ¥çœ‹ python è¿›ç¨‹çŠ¶æ€](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#psutil-%E6%9F%A5%E7%9C%8Bpython%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81)
    -   [guppy å–å¾—å†…å­˜ä½¿ç”¨çš„å„ç§å¯¹è±¡å ç”¨æƒ…å†µ](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#guppy-%E5%8F%96%E5%BE%97%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E7%9A%84%E5%90%84%E7%A7%8D%E5%AF%B9%E8%B1%A1%E5%8D%A0%E7%94%A8%E6%83%85%E5%86%B5)
    -   [æ— æ³•å›æ”¶çš„å¯¹è±¡](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#%E6%97%A0%E6%B3%95%E5%9B%9E%E6%94%B6%E7%9A%84%E5%AF%B9%E8%B1%A1)
        -   [ä¸å¯å›æ”¶å¯¹è±¡çš„ä¾‹å­ ğŸŒ°](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#%E4%B8%8D%E5%8F%AF%E5%9B%9E%E6%94%B6%E5%AF%B9%E8%B1%A1%E7%9A%84%E4%BE%8B%E5%AD%90-)
    -   [objgraph æŸ¥æ‰¾å¾ªç¯å¼•ç”¨](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#objgraph-%E6%9F%A5%E6%89%BE%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8)

è¿è¡Œç¯å¢ƒ:

    # uname -a
    Linux ** 3.10.0-327.el7.x86_64 #1 SMP Thu Nov 19 22:10:57 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux

    # python2 --version
    Python 2.7.5

    # cat /etc/*-release
    CentOS Linux release 7.2.1511 (Core) 

python ç¨‹åºåœ¨é•¿æ—¶é—´ (è¾ƒå¤§è´Ÿè½½) è¿è¡Œä¸€æ®µæ—¶é—´å, python è¿›ç¨‹çš„ç³»ç»Ÿå ç”¨å†…å­˜æŒç»­å‡é«˜:

    # ps aux | grep python2
    USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
    root     124910 10.2  0.8 5232084 290952 ?      Sl   Mar17 220:37 python2 offline.py restart
    #                                 ~~~~~~
    #                                 290M å†…å­˜å ç”¨ 

è¿™é‡Œçš„ python è¿›ç¨‹åœ¨ç»å†å¤§é‡è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­, å†…å­˜æŒç»­å‡é«˜, ä½†æœ€ç»ˆè´Ÿè½½å‹åŠ›ä¸‹é™ä¹‹å, å†…å­˜ä¸ªå¹¶æ²¡æœ‰ä¸‹é™.

ä¸ºäº†èŠ‚çœè¯»è€…æ—¶é—´, è¿™é‡Œå…ˆç»™å‡ºç»“è®º, åé¢å†è®°å½•è¯¦ç»†çš„æ’æŸ¥æ­¥éª¤.

æˆ‘ä»¬åˆ†å‡ ä¸ªæ­¥éª¤é€æ­¥å®šä½åˆ°é—®é¢˜æ‰€åœ¨:

-   é¦–å…ˆç¡®å®šå½“æ—¶ç¨‹åºåœ¨åšä»€ä¹ˆ, æ˜¯å¦æœ‰å¼‚å¸¸è¡Œä¸º.
-   æ’é™¤è¡Œä¸ºå¼‚å¸¸ä¹‹å, æŸ¥çœ‹ python çš„å†…å­˜ä½¿ç”¨æƒ…å†µ, æ˜¯å¦æ‰€æœ‰è¯¥å›æ”¶çš„å¯¹è±¡éƒ½å›æ”¶äº†.
-   æ’é™¤åƒåœ¾å›æ”¶ç­‰ python å†…éƒ¨çš„å†…å­˜æ³„æ¼é—®é¢˜å, å®šä½åˆ°æ—¶ libc çš„ malloc å®ç°çš„é—®é¢˜.

è€Œæœ€åçš„è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•, ç›´æ¥æ›¿æ¢ malloc æ¨¡å—ä¸º tcmalloc:

    LD_PRELOAD="/usr/lib64/libtcmalloc.so" python x.py 

## gdb-python: ææ¸…æ¥š python ç¨‹åºåœ¨åšä»€ä¹ˆ

é¦–å…ˆè¦ç¡®å®š python åœ¨åšä»€ä¹ˆ, æ˜¯ä¸æ˜¯æœ‰æ­£å¸¸çš„å¤§å†…å­˜æ¶ˆè€—ä»»åŠ¡åœ¨è¿è¡Œ, æ­»é”ç­‰å¼‚å¸¸è¡Œä¸º.

è¿™æ–¹é¢å¯ä»¥ç”¨ gdb æ¥å¸®å¿™, ä» gdb-7 å¼€å§‹, gdb æ”¯æŒç”¨ python æ¥å®ç° gdb çš„æ‰©å±•. æˆ‘ä»¬å¯ä»¥åƒè°ƒè¯• c ç¨‹åºé‚£æ ·, ç”¨ gdb å¯¹ python ç¨‹åºæ£€æŸ¥çº¿ç¨‹, è°ƒç”¨æ ˆç­‰.

**è€Œä¸”å¯ä»¥å°† python ä»£ç å’Œå†…éƒ¨çš„ c ä»£ç çš„è°ƒç”¨æ ˆåŒæ—¶æ‰“å°å‡ºæ¥**.

è¿™æ ·å¯¹ä¸ç¡®å®šæ˜¯ python ä»£ç é—®é¢˜è¿˜æ˜¯å…¶åº•å±‚ c ä»£ç çš„é—®é¢˜çš„æ—¶å€™, å¾ˆæœ‰å¸®åŠ©.

ä»¥ä¸‹æ­¥éª¤çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒ [debug-with-gdb](https://wiki.python.org/moin/DebuggingWithGdb).

* * *

### å‡†å¤‡ gdb

é¦–å…ˆå®‰è£… python çš„ debuginfo:

    # debuginfo-install python-2.7.5-39.el7_2.x86_64 

å¦‚æœç¼ºå°‘ debuginfo, è¿è¡Œåé¢çš„æ­¥éª¤ gdb ä¼šæç¤º blabla, æŒ‰ç…§æç¤ºå®‰è£…å®Œç»§ç»­å°±å¥½:

    Missing separate debuginfos, use: debuginfo-install python-2.7.5-39.el7_2.x86_64 

* * *

### æ¥å…¥ gdb

ç„¶åæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ gdb attach åˆ° 1 ä¸ª python è¿›ç¨‹, æ¥æŸ¥çœ‹å®ƒçš„è¿è¡ŒçŠ¶æ€:

attach ä¹‹åè¿›å…¥äº† gdb, èƒ½åšçš„äº‹æƒ…å°±å¤šäº†. å‡ ä¸ªåŸºæœ¬çš„æ£€æŸ¥æ­¥éª¤:

* * *

### æŸ¥çœ‹çº¿ç¨‹

    (gdb) info threads
      Id   Target Id         Frame
      206  Thread 0x7febdbfe3700 (LWP 124916) "python2" 0x00007febe9b75413 in select () at ../sysdeps/unix/syscall-template.S:81
      205  Thread 0x7febdb7e2700 (LWP 124917) "python2" 0x00007febe9b75413 in select () at ../sysdeps/unix/syscall-template.S:81
      204  Thread 0x7febdafe1700 (LWP 124918) "python2" 0x00007febe9b75413 in select () at ../sysdeps/unix/syscall-template.S:81
      203  Thread 0x7febda7e0700 (LWP 124919) "python2" 0x00007febe9b7369d in poll () at ../sysdeps/unix/syscall-template.S:81 

ä¸€èˆ¬åŠ é”æ­»é”å·®ä¸å¤šå¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°, ä¼šæœ‰çº¿ç¨‹å¡åœ¨ xx_wait ä¹‹ç±»çš„å‡½æ•°ä¸Š.

> ä¹‹å‰ç”¨è¿™ä¸ªæ–¹æ³•å®šä½äº† 1 ä¸ª python-logging æ¨¡å—å¼•èµ·çš„, åœ¨å¤šçº¿ç¨‹çš„è¿›ç¨‹ä¸­è¿è¡Œ fork, å¯¼è‡´ logging çš„é”è¢«é”ä½å fork åˆ°æ–°çš„è¿›ç¨‹, ä½†è§£é”çº¿ç¨‹æ²¡æœ‰ fork åˆ°æ–°è¿›ç¨‹è€Œé€ æˆçš„æ­»é”é—®é¢˜.

* * *

### æŸ¥çœ‹è°ƒç”¨æ ˆ

å¦‚æœå‘ç°æŸä¸ªçº¿ç¨‹æœ‰é—®é¢˜, åˆ‡æ¢åˆ°é‚£ä¸ªçº¿ç¨‹ä¸Š, æŸ¥çœ‹è°ƒç”¨æ ˆç¡®å®šå…·ä½“çš„æ‰§è¡Œæ­¥éª¤, ä½¿ç”¨`bt` å‘½ä»¤:

    (gdb) bt
    #16 0x00007febea8500bd in PyEval_EvalCodeEx (co=<optimized out>, globals=<optimized out>, locals=locals@entry=0x0, args=<optimized out>,
        argcount=argcount@entry=1, kws=0x38aa668, kwcount=2, defs=0x3282a88, defcount=2, closure=closure@entry=0x0)
        at /usr/src/debug/Python-2.7.5/Python/ceval.c:3330

    ...

    #19 PyEval_EvalFrameEx (
        f=f@entry=Frame 0x38aa4d0, for file t.py, line 647, in run (part_num=2, consumer=<... 

`bt` å‘½ä»¤ä¸ä»…å¯ä»¥çœ‹åˆ° c çš„è°ƒç”¨æ ˆ, è¿˜ä¼šæ˜¾ç¤ºå‡º python æºç çš„è°ƒç”¨æ ˆ, æƒ³ä¸Šé¢ frame-16 æ˜¯ c çš„, frame-19 æ˜¾ç¤ºå‡ºåœ¨ python çš„æºä»£ç å¯¹åº”å“ª 1 è¡Œ.

å¦‚æœåªæŸ¥çœ‹ python çš„ä»£ç çš„è°ƒç”¨æ ˆ, ä½¿ç”¨`py-bt`å‘½ä»¤:

    (gdb) py-bt
    #1 <built-in method poll of select.epoll object at remote 0x7febeacc5930>
    #3 Frame 0x3952450, for file /usr/lib64/python2.7/site-packages/twisted/internet/epollreactor.py, line 379, in doPoll (self=<...
        l = self._poller.poll(timeout, len(self._selectables))
    #7 Frame 0x39502a0, for file /usr/lib64/python2.7/site-packages/twisted/internet/base.py, line 1204, in mainLoop (self=<... 

`py-bt`æ˜¾ç¤ºå‡º python æºç çš„è°ƒç”¨æ ˆ, è°ƒç”¨å‚æ•°, ä»¥åŠæ‰€åœ¨è¡Œçš„ä»£ç .

* * *

### coredump

å¦‚æœè¦è¿›è¡Œæ¯”è¾ƒé•¿æ—¶é—´çš„è·Ÿè¸ª, æœ€å¥½å°† python ç¨‹åºçš„è¿›ç¨‹ä¿¡æ¯å…¨éƒ¨ coredump å‡ºæ¥, ä¹‹åå¯¹ core æ–‡ä»¶è¿›è¡Œåˆ†æ, é¿å…å½±å“æ­£åœ¨è¿è¡Œçš„ç¨‹åº.

è¿™æ¡å‘½ä»¤å°†å½“å‰ gdb attach çš„ç¨‹åº dump åˆ°å®ƒçš„è¿è¡Œç›®å½•, åå­—ä¸º`core.<pid>`, ç„¶åå†ç”¨ gdb åŠ è½½è¿™ä¸ª core æ–‡ä»¶, è¿›è¡Œæ‰“å°å †æ ˆ, æŸ¥çœ‹å˜é‡ç­‰åˆ†æ, æ— éœ€ attach åˆ°æ­£åœ¨è¿è¡Œçš„ç¨‹åº:

* * *

### å…¶ä»–å‘½ä»¤

å…¶ä»–å‘½ä»¤å¯ä»¥åœ¨ gdb è¾“å…¥`py<TAB><TAB>` çœ‹åˆ°, å’Œ gdb çš„å‘½ä»¤å¯¹åº”, ä¾‹å¦‚:

    (gdb) py
    py-bt               py-list             py-print            python
    py-down             py-locals           py-up               python-interactive 

-   `py-up`, `py-down` å¯ä»¥ç”¨æ¥ç§»åŠ¨åˆ° python è°ƒç”¨ç«™çš„ä¸Šä¸€ä¸ªæˆ–ä¸‹ä¸€ä¸ª frame.
-   `py-locals` ç”¨æ¥æ‰“å°å±€éƒ¨å˜é‡

ç­‰ç­‰ç­‰ç­‰. gdb é‡Œä¹Ÿå¯ä»¥ç”¨`help`å‘½ä»¤æŸ¥çœ‹å¸®åŠ©:

    (gdb) help py-print
    Look up the given python variable name, and print it 

* * *

åœ¨è¿™æ¬¡è¿½è¸ªè¿‡ç¨‹ä¸­, ç”¨ gdb-python æ’é™¤äº†ç¨‹åºé€»è¾‘é—®é¢˜. ç„¶åç»§ç»­è¿½è¸ªå†…å­˜æ³„æ¼é—®é¢˜:

## pyrasite: è¿æ¥è¿›å…¥ python ç¨‹åº

pyrasite æ˜¯ 1 ä¸ªå¯ä»¥ç›´æ¥è¿ä¸Šä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ python ç¨‹åº, æ‰“å¼€ä¸€ä¸ªç±»ä¼¼ ipython çš„äº¤äº’ç»ˆç«¯æ¥è¿è¡Œå‘½ä»¤æ¥æ£€æŸ¥ç¨‹åºçŠ¶æ€.

è¿™ç»™æˆ‘ä»¬çš„è°ƒè¯•æä¾›äº†éå¸¸å¤§çš„æ–¹ä¾¿. ç®€ç›´ç¥å™¨.

å®‰è£…:

    # pip install pyrasite
    ...

    # pip show pyrasite
    Name: pyrasite
    Version: 2.0
    Summary: Inject code into a running Python process
    Home-page: http://pyrasite.com
    Author: Luke Macken
    ... 

è¿æ¥åˆ°æœ‰é—®é¢˜çš„ç¨‹åºä¸Š, å¼€å§‹æ”¶é›†ä¿¡æ¯:

æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨`<pid>`çš„è¿›ç¨‹é‡Œè°ƒç”¨ä»»æ„çš„ python ä»£ç , æ¥æŸ¥çœ‹è¿›ç¨‹çš„çŠ¶æ€.

ä¸‹é¢æ˜¯å‡ ä¸ªå°å…¬ä¸¾ (ç‰¹ä¹ˆçš„è¾“å…¥æ³•æˆ‘æ˜¯è¯´å·¥å…·..) å¯ä»¥ç”¨æ¥åœ¨è¿›ç¨‹å†…æŸ¥çœ‹å†…å­˜çŠ¶æ€çš„:

## psutil æŸ¥çœ‹ python è¿›ç¨‹çŠ¶æ€

é¦–å…ˆçœ‹ä¸‹ python è¿›ç¨‹å ç”¨çš„ç³»ç»Ÿå†…å­˜ RSS:

    pyrasite-shell 11122
    >>> import psutil, os
    >>> psutil.Process(os.getpid()).memory_info().rss
    29095232 

åŸºæœ¬å’Œ ps å‘½ä»¤æ˜¾ç¤ºçš„ç»“æœä¸€è‡´

> rss the real memory (resident set) size of the process (in 1024 byte units).

## guppy å–å¾—å†…å­˜ä½¿ç”¨çš„å„ç§å¯¹è±¡å ç”¨æƒ…å†µ

guppy å¯ä»¥ç”¨æ¥æ‰“å°å‡ºå„ç§å¯¹è±¡å„å ç”¨å¤šå°‘ç©ºé—´, å¦‚æœ python è¿›ç¨‹ä¸­æœ‰æ²¡æœ‰é‡Šæ”¾çš„å¯¹è±¡, é€ æˆå†…å­˜å ç”¨å‡é«˜, é€šè¿‡ guppy å¯ä»¥æŸ¥çœ‹å‡ºæ¥:

> åŒæ ·, ä»¥ä¸‹æ­¥éª¤æ˜¯åœ¨é€šè¿‡ pyrasite-shell, attach åˆ°ç›®æ ‡è¿›ç¨‹åæ“ä½œçš„.

    # pip install guppy from guppy import hpy
    h = hpy()

    h.heap()
    # Partition of a set of 48477 objects. Total size = 3265516 bytes.
    #  Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)
    #      0  25773  53  1612820  49   1612820  49 str
    #      1  11699  24   483960  15   2096780  64 tuple
    #      2    174   0   241584   7   2338364  72 dict of module
    #      3   3478   7   222592   7   2560956  78 types.CodeType
    #      4   3296   7   184576   6   2745532  84 function
    #      5    401   1   175112   5   2920644  89 dict of class
    #      6    108   0    81888   3   3002532  92 dict (no owner)
    #      7    114   0    79632   2   3082164  94 dict of type
    #      8    117   0    51336   2   3133500  96 type
    #      9    667   1    24012   1   3157512  97 __builtin__.wrapper_descriptor
    # <76 more rows. Type e.g. '_.more' to view.> 
    h.iso(1,[],{})
    # Partition of a set of 3 objects. Total size = 176 bytes.
    #  Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)
    #      0      1  33      136  77       136  77 dict (no owner)
    #      1      1  33       28  16       164  93 list
    #      2      1  33       12   7       176 100 int 

é€šè¿‡ä»¥ä¸Šæ­¥éª¤, å¯ä»¥çœ‹å‡ºå¹¶æ²¡æœ‰å¾ˆå¤š python å¯¹è±¡å ç”¨æ›´å¤§å†…å­˜.

## æ— æ³•å›æ”¶çš„å¯¹è±¡

python æœ¬èº«æ˜¯æœ‰åƒåœ¾å›æ”¶çš„, ä½† python ç¨‹åºä¸­æœ‰ç§æƒ…å†µæ˜¯å¯¹è±¡æ— æ³•è¢«åƒåœ¾å›æ”¶æ‰ (uncollectable object), æ»¡è¶³ 2 ä¸ªæ¡ä»¶:

-   å¾ªç¯å¼•ç”¨
-   å¾ªç¯å¼•ç”¨çš„é“¾ä¸ŠæŸä¸ªå¯¹è±¡å®šä¹‰äº†`__del__`æ–¹æ³•.

å®˜æ–¹çš„è¯´æ³•æ˜¯, å¾ªç¯å¼•ç”¨çš„ä¸€ç»„å¯¹è±¡è¢« gc æ¨¡å—è¯†åˆ«ä¸ºå¯å›æ”¶çš„, ä½†éœ€è¦å…ˆè°ƒç”¨æ¯ä¸ªå¯¹è±¡ä¸Šçš„`__del__`æ–¹æ³•, æ‰èƒ½å›æ”¶. ä½†ç”¨æˆ·è‡ªå®šä¹‰äº†`__del__`çš„å¯¹è±¡, gc ç³»ç»Ÿä¸çŸ¥é“åº”è¯¥å…ˆè°ƒç”¨ç¯ä¸Šçš„å“ªä¸ª`__del__`. å› æ­¤æ— æ³•å›æ”¶è¿™ç±»å¯¹è±¡.

ä¸èƒ½å›æ”¶çš„ python å¯¹è±¡ä¼šæŒç»­å æ®å†…å­˜, å½“é—®é¢˜æŸ¥åˆ°è¿™é‡Œæ—¶æˆ‘ä»¬æ€€ç–‘æœ‰ä¸èƒ½è¢«å›æ”¶çš„å¯¹è±¡å¯¼è‡´å†…å­˜æŒç»­å‡é«˜.

äºæ˜¯æˆ‘ä»¬å°è¯•åˆ—å‡ºæ‰€æœ‰ä¸èƒ½å›æ”¶çš„å¯¹è±¡.

> åæ¥ç¡®å®šä¸æ˜¯è¿™ç§é—®é¢˜å¼•èµ·çš„å†…å­˜ä¸é‡Šæ”¾. ä¸èƒ½å›æ”¶ä»»ç„¶å¯ä»¥é€šè¿‡`gc.get_objects()` åˆ—å‡ºæ¥, å¹¶ä¼šåœ¨`gc.collect()`è°ƒç”¨åè¢«åŠ å…¥åˆ°`gc.garbage`çš„ list é‡Œ. ä½†æˆ‘ä»¬æ²¡æœ‰å‘ç°è¿™ç±»å¯¹è±¡çš„å­˜åœ¨.

æŸ¥æ‰¾ uncollectable çš„å¯¹è±¡:

    pyrasite-shell 11122
    >>> import gc
    >>> gc.collect() # first run gc, find out uncollectable object and put them in gc.garbage
                     # output number of object collected
    >>> gc.garbage   # print all uncollectable objects
    []               # empty 

å¦‚æœåœ¨ä¸Šé¢æœ€åä¸€æ­¥æ‰“å°å‡ºäº†ä»»ä½•ä¸èƒ½å›æ”¶çš„å¯¹è±¡, åˆ™éœ€è¦è¿›ä¸€æ­¥æŸ¥æ‰¾å¾ªç¯å¼•ç”¨é“¾ä¸Šåœ¨å“ªä¸ªå¯¹è±¡ä¸ŠåŒ…å«`__del__`æ–¹æ³•.

ä¸‹é¢æ˜¯ 1 ä¸ªä¾‹å­æ¥æ¼”ç¤ºå¦‚ä½•ç”Ÿæˆä¸èƒ½å›æ”¶çš„å¯¹è±¡:

### ä¸å¯å›æ”¶å¯¹è±¡çš„ä¾‹å­ ğŸŒ°

[uncollectible.py](https://drmingdrmer.github.io/post-res/python-mem/uncollectible.py)

    from __future__ import print_function

    import gc

    '''
    This snippet shows how to create a uncollectible object:
    It is an object in a cycle reference chain, in which there is an object
    with __del__ defined.
    The simpliest is an object that refers to itself and with a __del__ defined.

        > python uncollectible.py

        ======= collectible object =======

        *** init,     nr of referrers: 4
                      garbage:         []
                      created:         collectible: <__main__.One object at 0x102c01090>
                      nr of referrers: 5
                      delete:
        *** __del__ called
        *** after gc, nr of referrers: 4
                      garbage:         []

        ======= uncollectible object =======

        *** init,     nr of referrers: 4
                      garbage:         []
                      created:         uncollectible: <__main__.One object at 0x102c01110>
                      nr of referrers: 5
                      delete:
        *** after gc, nr of referrers: 5
                      garbage:         [<__main__.One object at 0x102c01110>]

    '''

    def dd(*msg):
        for m in msg:
            print(m, end='')
        print()

    class One(object):

        def __init__(self, collectible):
            if collectible:
                self.typ = 'collectible'
            else:
                self.typ = 'uncollectible'

                # Make a reference to it self, to form a reference cycle.
                # A reference cycle with __del__, makes it uncollectible.
                self.me = self

        def __del__(self):
            dd('*** __del__ called')

    def test_it(collectible):

        dd()
        dd('======= ', ('collectible' if collectible else 'uncollectible'), ' object =======')
        dd()

        gc.collect()
        dd('*** init,     nr of referrers: ', len(gc.get_referrers(One)))
        dd('              garbage:         ', gc.garbage)

        one = One(collectible)
        dd('              created:         ', one.typ, ': ', one)
        dd('              nr of referrers: ', len(gc.get_referrers(One)))

        dd('              delete:')
        del one

        gc.collect()

        dd('*** after gc, nr of referrers: ', len(gc.get_referrers(One)))
        dd('              garbage:         ', gc.garbage)

    if __name__ == "__main__":
        test_it(collectible=True)
        test_it(collectible=False) 

ä¸Šé¢è¿™æ®µä»£ç åˆ›å»ºäº† 2 ä¸ªå¯¹è±¡, 1 ä¸ªå¯ä»¥å›æ”¶, 1 ä¸ªä¸èƒ½å›æ”¶, ä»–ä»¬ 2 ä¸ªéƒ½å®šä¹‰äº†`__del__`æ–¹æ³•, å”¯ä¸€åŒºåˆ«å°±æ˜¯æ˜¯å¦å¼•ç”¨äº†è‡ªå·± (ä»è€Œæ„æˆäº†å¼•ç”¨ç¯).

å¦‚æœåœ¨è¿™ä¸ªæ­¥éª¤å‘ç°äº†å¾ªç¯å¼•ç”¨, å°±è¦è¿›ä¸€æ­¥æŸ¥å¤„å“ªäº›å¼•ç”¨å…³ç³»é€ æˆäº†å¾ªç¯å¼•ç”¨, è¿›è€Œç ´åæ‰å¾ªç¯å¼•ç”¨, è®©å¯¹è±¡å˜æˆå¯ä»¥å›æ”¶çš„.

## objgraph æŸ¥æ‰¾å¾ªç¯å¼•ç”¨

    # pip install objgraph
    pyrasite-shell 11122
    >>> import objgraph
    >>> objgraph.show_refs([an_object], filename='sample-graph.png') 

ä¸Šé¢çš„ä¾‹å­ä¸­, å°†åœ¨æœ¬åœ°ç”Ÿæˆä¸€ä¸ªå›¾ç‰‡, æè¿°ç”±å¯ä»¥ç”± an_object å¼•ç”¨åˆ°çš„å…³ç³»å›¾:

![](https://mg.pov.lt/objgraph/_images/sample-graph.png)

å…·ä½“å‚è€ƒ: [objgraph](https://mg.pov.lt/objgraph/)

> åœ¨è¿™ä¸€æ­¥æˆ‘ä»¬ä¹Ÿæ²¡æœ‰æ‰¾åˆ°ä¸èƒ½å›æ”¶çš„å¯¹è±¡, æœ€åæˆ‘ä»¬æ€€ç–‘åˆ°æ—¶ glibc çš„ malloc çš„é—®é¢˜, ç”¨ tcmalloc æ›¿ä»£ glibc é»˜è®¤çš„ malloc åé—®é¢˜å¾—åˆ°ä¿®å¤.

* * *

##### Archive

-   18 Oct 2020 [ååˆ†å¸ƒå¼æ—¶ä»£: å¤šæ•°æ´¾è¯»å†™çš„'å°‘æ•°æ´¾'å®ç°](https://drmingdrmer.github.io/algo/2020/10/18/quorum.html)
-   20 Dec 2019 [Art of Pull Requests(ç¿»è¯‘)](https://drmingdrmer.github.io/culture/2019/12/20/pr.html)
-   21 Nov 2019 [ææŒ‡ç®—ç®—: ä½ çš„ CDN å¤šèŠ±äº†å‡ ç™¾ä¸‡?](https://drmingdrmer.github.io/tech/architecture/2019/11/21/cdn.html)
-   19 Nov 2019 [ä¸€å¹´çš„ç´ æç»ƒä¹ ](https://drmingdrmer.github.io/drawing/2019/11/19/drawing.html)
-   30 Oct 2019 [äº’è”ç½‘ä¸­å¯¹è±¡è®¿é—®é¢‘ç‡çš„ 91 åˆ†å¸ƒ](https://drmingdrmer.github.io/tech/2019/10/30/zipf.html)
-   09 Jan 2019 [å“„å¥½é¢è¯•å®˜ç³»åˆ— - 1: æ¯”è¾ƒ 2 ä¸ª python dict(å¤šçº§) æ˜¯å¦ç›¸åŒ](https://drmingdrmer.github.io/tech/algorithm/2019/01/09/dict-cmp.html)
-   04 Nov 2018 [å­˜å‚¨ä¸­çš„æ–‡ä»¶åˆå¹¶ç­–ç•¥ä¼˜åŒ–](https://drmingdrmer.github.io/tech/algorithm/2018/11/04/compact.html)
-   27 Sep 2018 [è½¯ä»¶å·¥ç¨‹æ˜¯ä¸ªé¢åŒ…æœº](https://drmingdrmer.github.io/tech/bla/2018/09/27/toaster.html)
-   26 Aug 2018 [ç¨‹åºå‘˜å¿…é¡»çŸ¥é“çš„äº‹æƒ…, ä¸€èˆ¬äººæˆ‘ä¸å‘Šè¯‰ä»–](https://drmingdrmer.github.io/tech/bla/2018/08/26/programmer-should-know.html)
-   16 Aug 2018 [cgexec æ— æ³•ç»§æ‰¿ LD_PRELOAD ç¯å¢ƒå˜é‡](https://drmingdrmer.github.io/tech/cgroup/2018/08/16/cgexec.html)
-   04 Aug 2018 [mysql group replication å®è·µè®°å½•: æ­¥éª¤, é—®é¢˜å’Œæ³¨æ„äº‹é¡¹](https://drmingdrmer.github.io/tech/mysql/2018/08/04/mysql-group-replication.html)
-   13 Feb 2018 [æšä¸¾æ‰€æœ‰æ•´å‹¾è‚¡æ•°](https://drmingdrmer.github.io/math/2018/02/13/enumerate-pythagorean-int.html)
-   03 Feb 2018 [ansible ä¸­çš„ include, include_tasks å’Œ import_tasks çš„å·®åˆ«](https://drmingdrmer.github.io/tech/devops/2018/02/03/ansible-import-include.html)
-   20 Nov 2017 [python å¹¶å‘ subprocess.Popen çš„å‘](https://drmingdrmer.github.io/tech/programming/2017/11/20/python-concurrent-popen.html)
-   05 Aug 2017 [ç¨‹åºå‘˜å¿…è¯»: æ‘¸æ¸… hash è¡¨çš„è„¾æ€§](https://drmingdrmer.github.io/math/hash/2017/08/05/numbers-programmers-should-know-about-hash-zh.html)
-   06 May 2017 [python è¿›ç¨‹å†…å­˜å¢é•¿é—®é¢˜, è§£å†³æ–¹æ³•å’Œå·¥å…·](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html)
-   01 Feb 2017 [xp çš„åˆ†å¸ƒå¼ç³»ç»Ÿç³»åˆ—æ•™ç¨‹ä¹‹: Erasure-Code: å·¥ä½œåŸç†, æ•°å­¦è§£é‡Š, å®è·µå’Œåˆ†æ.](https://drmingdrmer.github.io/tech/distributed/2017/02/01/ec-img.html)
-   01 Feb 2017 [xp çš„åˆ†å¸ƒå¼ç³»ç»Ÿç³»åˆ—æ•™ç¨‹ä¹‹: Erasure-Code: å·¥ä½œåŸç†, æ•°å­¦è§£é‡Š, å®è·µå’Œåˆ†æ.](https://drmingdrmer.github.io/tech/distributed/2017/02/01/ec.html)
-   11 Nov 2015 [å¯é åˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€ Paxos çš„ç›´è§‚è§£é‡Š](https://drmingdrmer.github.io/tech/distributed/2015/11/11/paxos-slide.html)
-   28 Jul 2015 [socket å…³é—­: close() å’Œ shutdown() çš„å·®å¼‚](https://drmingdrmer.github.io/tech/programming/network/2015/07/28/close-shutdown.html)
-   17 May 2015 [éšæ‰‹æ”¹å˜ä¸–ç•Œä¹‹ git-auto-squash](https://drmingdrmer.github.io/git/2015/05/17/git-auto-squash.html)
-   17 Feb 2015 [Numbers Programmers Should Know About Hash](https://drmingdrmer.github.io/math/hash/2015/02/17/numbers-programmers-should-know-about-hash.html)
-   11 Feb 2015 [Vim-tabbar: Simple, stupid and fast tab-bar for VIM](https://drmingdrmer.github.io/tech/vim/2015/02/11/vim-tabbar.html)
-   24 Jul 2014 [1% æ…¢è¯·æ±‚ä¼˜åŒ–](https://drmingdrmer.github.io/math/engineering/2014/07/24/slow-request.html)
-   31 Jan 2014 [Some useful resources](https://drmingdrmer.github.io/tech/programming/2014/01/31/resource.html)
-   31 Jan 2014 [jobq.py -- Queue processing engine](https://drmingdrmer.github.io/tech/programming/2014/01/31/jobq.html)

    [https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#psutil-%E6%9F%A5%E7%9C%8Bpython%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#psutil-%E6%9F%A5%E7%9C%8Bpython%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81) 
    [https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#psutil-%E6%9F%A5%E7%9C%8Bpython%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#psutil-%E6%9F%A5%E7%9C%8Bpython%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81)
